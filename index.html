<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WI Ironworker Jurisdictions</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body,#map{height:100%;margin:0}
    .panel{
      position:absolute;top:10px;left:10px;z-index:1000;background:#fff;
      padding:8px 10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.2);
      font:14px system-ui,sans-serif;display:flex;gap:6px;flex-wrap:wrap;align-items:center
    }
    .panel input{width:260px;max-width:48vw}
    .legend{
      position:absolute;bottom:10px;left:10px;z-index:1000;background:#fff;
      padding:8px 10px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.2);
      font:13px system-ui,sans-serif;line-height:1.3
    }
    .sw{display:inline-block;width:12px;height:12px;margin-right:6px;border-radius:3px;vertical-align:middle}
  </style>
</head>
<body>
  <div class="panel">
    <input id="from" placeholder="From address or lat,lng" />
    <input id="to"   placeholder="To address or lat,lng" />
    <button id="routeBtn">Route</button>
    <span id="msg" style="font-weight:600"></span>
  </div>
  <div id="map"></div>
  <div id="legend" class="legend"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6"></script>
  <script>
  // ---------- config ----------
  const GEOJSON_URL = 'jurisdictions.json';      // your file
  const GEOAPIFY_KEY = '66dd3a5b023f4dc6bbe5b8dac54b3a00';      // <-- put your key here
  const COLORS = {                               // color per zone (edit names to match your data)
    'Local 498':'#4186f0',
    'Local 383':'#f57c00',
    'Local 8 Southern':'#795548',
    'Local 498 Eastern Zone':'#0ba9cc',
    'Local 8 Northern':'#c2185b',
    'Local 8 Upper Peninsula':'#ffea00',
    'Local 512 A':'#9c27b0',
    'Local 512 B':'#006064'
  };

  let map, zones, zoneLayer, routeLayer, markers = [];

  (async function init(){
    map = L.map('map').setView([43.8,-89.8], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Load and draw zones
    zones = await (await fetch(GEOJSON_URL)).json();
    zoneLayer = L.geoJSON(zones, {
      style: f => ({
        color: '#2c3e50', weight: 1,
        fillColor: COLORS[labelFor(f)] || '#467fd0', fillOpacity: 0.18
      }),
      onEachFeature: (f, layer) => {
        layer.on('mouseover', () => layer.setStyle({weight:2, fillOpacity:0.28}));
        layer.on('mouseout',  () => layer.setStyle({weight:1, fillOpacity:0.18}));
        layer.on('click', e => setMsg(`Zone: ${labelFor(f)}`));
      }
    }).addTo(map);
    map.fitBounds(zoneLayer.getBounds());

    // Click anywhere â†’ which zone?
    map.on('click', e => {
      const pt = turf.point([e.latlng.lng, e.latlng.lat]);
      const hit = zones.features.find(f => turf.booleanPointInPolygon(pt, f));
      setMsg(hit ? `Zone: ${labelFor(hit)}` : 'Outside all zones');
    });

    // Legend
    const legend = document.getElementById('legend');
    legend.innerHTML = Object.entries(COLORS)
      .map(([name, color]) => `<div><span class="sw" style="background:${color}"></span>${name}</div>`)
      .join('');

    // Routing button
    document.getElementById('routeBtn').onclick = route;
  })();

  function labelFor(f){
    const p = f.properties || {};
    return p.local || p.name || 'Unknown';
  }
  function setMsg(t){ document.getElementById('msg').textContent = t; }

  // ---- routing with Geoapify ----
  async function route(){
    clearRoute();
    const a = document.getElementById('from').value.trim();
    const b = document.getElementById('to').value.trim();
    if(!a || !b) return setMsg('Enter both From and To');

    const A = await toLatLng(a);
    const B = await toLatLng(b);
    if(!A || !B){ setMsg('Could not geocode one of the inputs'); return; }

    // markers
    markers.push(L.marker(A).addTo(map).bindPopup('A').openPopup());
    markers.push(L.marker(B).addTo(map).bindPopup('B'));

    // Geoapify Routing API
    // NOTE: Geoapify expects waypoint order "lon,lat|lon,lat"
    const wp = `${A.lng},${A.lat}|${B.lng},${B.lat}`;
    const url = `https://api.geoapify.com/v1/routing?waypoints=${encodeURIComponent(wp)}&mode=drive&apiKey=${GEOAPIFY_KEY}`;

    try{
      const r = await fetch(url);
      if(!r.ok){ setMsg('Routing failed'); return; }
      const gj = await r.json();                     // returns GeoJSON FeatureCollection
      routeLayer = L.geoJSON(gj, {
        style: { color:'#0066ff', weight:4, opacity:0.9 }
      }).addTo(map);
      map.fitBounds(routeLayer.getBounds(), { padding:[20,20] });
      setMsg('Route drawn');
    }catch(e){
      console.error(e); setMsg('Routing error (see console)');
    }
  }

  async function toLatLng(text){
    // supports "lat,lng" or address (via Geoapify geocoding)
    const m = text.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
    if(m){ return { lat: parseFloat(m[1]), lng: parseFloat(m[3]) }; }

    const url = `https://api.geoapify.com/v1/geocode/search?text=${encodeURIComponent(text)}&limit=1&apiKey=${GEOAPIFY_KEY}`;
    const r = await fetch(url); if(!r.ok) return null;
    const j = await r.json();
    const feat = j.features?.[0]; if(!feat) return null;
    return { lat: feat.geometry.coordinates[1], lng: feat.geometry.coordinates[0] }; // [lon,lat]
  }

  function clearRoute(){
    if(routeLayer){ map.removeLayer(routeLayer); routeLayer = null; }
    markers.forEach(m => map.removeLayer(m)); markers = [];
    setMsg('');
  }
  </script>
</body>
</html>
